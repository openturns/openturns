on:
  push:
    branches: [ master ]
  pull_request:
jobs:
  macos:
    runs-on: macos-latest
    env:
      LDFLAGS: -L/usr/local/opt/openblas/lib
      CPPFLAGS: -I/usr/local/opt/openblas/include
    steps:
    - uses: actions/checkout@v4
    - run: |
        brew upgrade
        brew install openblas swig boost python3 tbb nlopt cminpack ceres-solver bison flex hdf5 ipopt primesieve spectra pagmo
    - run: |
        cd $HOME/work/openturns
        git clone -b 1.9.0 https://github.com/jeromerobert/hmat-oss.git hmat-oss
        cd hmat-oss/
        cmake -DBUILD_EXAMPLES=OFF -DCBLAS_INCLUDE_DIR=/usr/local/opt/openblas/include -DCMAKE_MACOSX_RPATH=ON .
        make install -j3
    - run: |
        cmake \
        -DFLEX_EXECUTABLE=/usr/local/opt/flex/bin/flex \
        -DBISON_EXECUTABLE=/usr/local/opt/bison/bin/bison \
        -DSWIG_COMPILE_FLAGS="-O1 -Wno-unused-parameter -Wno-unused-function -Wno-deprecated-declarations -Wno-missing-field-initializers" \
        -DCMAKE_UNITY_BUILD=ON -DCMAKE_UNITY_BUILD_BATCH_SIZE=32 .
        make t_KarhunenLoeveP1Algorithm_std
        OPENTURNS_NUM_THREADS=2 OMP_NUM_THREADS=1 ctest -R cppcheck_KarhunenLoeveP1Algorithm_std --output-on-failure --repeat-until-fail 100000 -V

